{% extends "home/social_base.html" %}
{% load static %}
{% block content %}


    <div class="view-wrapper">

        <!-- Container -->
        <div class="container is-custom">
           <div class="minimal-profile-wrapper">
            <!-- Profile page main wrapper -->
            <div id="profile-about" class="view-wrap is-headless">
                <div class="columns is-multiline no-margin">
                    <!-- Left side column -->
                    <div class="column" style="background: #fff; margin: 1rem .75rem;">


                    <div class="profile-info">
                        <div class="left" style="margin-bottom: 5em;">
                            <div class="profile-avatar">
                                <img id="user-avatar-minimal" style="object-fit: cover;margin-top: 5em;" src="{{ profile_user.get_profile_img }}" data-demo-src="{{ profile_user.get_profile_img }}" alt="">
                                {% if request.user == profile_user %}
                                <button class="button is-solid secondary-button raised modal-trigger" style="margin-top: 4em;top: 100px;" data-modal="change-profile-pic-modal">
                                    <i data-feather="plus"></i>
                                </button>
                                {% endif %}
                            </div>
                            <div style="padding-top: 4em;">
                            <a class="button is-fullwidth modal-trigger" data-modal="change-profile-pic-modal" >
                                <i data-feather="camera"></i>
                                <span>Update Profile</span>
                            </a>
                            </div>
                        </div>

                        <div class="right">
                            <div class="head" style="padding: 0em;margin-bottom: 0em;">
                                <h2>{{profile_user.get_full_name}}</h2>
                                <div class="actions">
                                    {% if profile_user == request.user %}
                                    <a class="button" style="border: none;padding: 0em;margin: 0em;"></a>
                                    {% elif request_already_sent %}
                                    <a class="button is-solid secondary-button raised">Request Sent</a>
                                    {% elif profile_user in request.user.get_user_connected_users %}
                                    <a class="button is-solid secondary-button raised">Send Message</a>
                                    {% else %}
                                    <form method="POST" onsubmit="sendFriendRequest(event);$(this).next().show();$(this).hide();">
                                        {% csrf_token %}
                                        <input type="hidden" name="id" value="{{profile_user.id}}">
                                        <button type="submit" class="button is-solid secondary-button raised">Send Request</button>
                                    </form>
                                    {% endif %}

                                </div>
                            </div>
                            <div class="stats">
<!--                                <span>174 posts</span>-->
                                <span><i class="mdi mdi-account-group"></i> &nbsp;&nbsp;{{connected_users.count}} Friends</span>
                                <span><i class="mdi mdi-progress-check"></i> &nbsp;&nbsp; {{form.designation.value}}</span>
                            </div>
                            <div class="bio">
                                <p>{{form.bio.value}}</p>
                            </div>
                        </div>
                    </div>


<!--                    </div>-->

                        <!-- Timeline Header -->
                        <div class="cover-bg" style="margin-top: 5em;">
<!--                            <br><br><br><br><br><br>-->
<!--                             <img class="cover-image" src="https://via.placeholder.com/1600x460" data-demo-src="https://friendkit.cssninja.io/assets/img/demo/bg/4.png" alt="">-->
                            <div class="avatar">
                                <img id="user-avatar" class="avatar-image" src="{{ profile_user.get_profile_img }}" data-demo-src="{{ profile_user.get_profile_img }}" alt="">
                                {% if request.user == profile_user %}
                                <div class="avatar-button">
                                    <i data-feather="plus"></i>
                                </div>
                                {% endif %}
                                <div class="pop-button is-left has-tooltip modal-trigger" data-modal="change-profile-pic-modal" data-placement="right" data-title="Change profile picture">
                                    <a class="inner">
                                        <i data-feather="camera"></i>
                                    </a>
                                </div>
<!--                                <div id="follow-pop" class="pop-button pop-shift is-left has-tooltip" data-placement="top" data-title="Subscription">-->
<!--                                    <a class="inner">-->
<!--                                        <i class="inactive-icon" data-feather="bell"></i>-->
<!--                                        <i class="active-icon" data-feather="bell-off"></i>-->
<!--                                    </a>-->
<!--                                </div>-->
                                <!-- <div id="invite-pop" class="pop-button pop-shift is-left has-tooltip" data-placement="top" data-title="Relationship">
                                    <a href="#" class="inner">
                                        <i class="inactive-icon" data-feather="plus"></i>
                                        <i class="active-icon" data-feather="minus"></i>
                                    </a>
                                </div> -->
                                <div id="chat-pop" class="pop-button is-center has-tooltip" data-placement="right" data-title="Chat">
                                    <a href="{% url 'chat:chat' %}" class="inner">
                                        <i data-feather="message-circle"></i>
                                    </a>
                                </div>
                                <div class="pop-button is-right has-tooltip" data-placement="right" data-title="Send message">
                                    <a href="mailto:{{profile_user.email}}" class="inner">
                                        <i data-feather="mail"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="cover-overlay"></div>

                        </div>

                        <div class="profile-menu is-hidden-mobile">
<!--                            <div class="menu-start">-->
<!--                                <a href="profile-main.html" class="button has-min-width">{{form.designation.value}}</a>-->
<!--                                <a href="profile-about.html" class="button has-min-width">About</a>-->
<!--                            </div>-->
<!--                            <div class="menu-end">-->
<!--                                <a id="profile-friends-link" href="profile-friends.html" class="button has-min-width">Friends</a>-->
<!--                                <a href="profile-photos.html" class="button has-min-width">Photos</a>-->
<!--                            </div>-->
                        </div>

                        <div class="profile-subheader">
                            <div class="subheader-start is-hidden-mobile" style="float: right;">
<!--                                <span>{{connected_users.count}}</span>-->
<!--                                <span>Friends</span>-->
                                <a class="button has-icon is-solid accent-button is-bold">
                                    <i class="mdi mdi-account-group"></i>
                                    &nbsp;&nbsp;&nbsp;
                                    <span style="all:inherit; border:none; padding: 0;" id="total-friends-counter">{{connected_users.count}}</span>&nbsp;Friends
                                </a>

                                {% if form.bio.value %}
                                <p class="p-2 mt-2" style="font-size: 12px;"><i class="mdi mdi-information-outline"></i>  &nbsp;&nbsp;{{form.bio.value}}</p>
                                {% endif %}
                                <!--                                <p class="p-2" style="font-size: 12px;font-weight: bold;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-briefcase"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>  &nbsp;&nbsp;Manager</p>-->

                            </div>
                            <div class="subheader-middle" style="margin-top: 4em;">
                                <h2>{{profile_user.get_full_name}}</h2>
                                <span>{{profile_user.username}}</span>
                            </div>
                            <div class="subheader-end is-hidden-mobile" style="display: flex; justify-content: end;">

                                {% if profile_user == request.user %}
                                <!-- If profile_user is request.user -->

                                {% elif profile_user in request.user.get_user_connected_users %}
                                <a href="{% url 'chat:chat' %}" class="button has-icon is-bold menu-item" style="min-width: 130px;background: #5596e6;color: #fff;" data-content="education-content">
                                    <i class="mdi mdi-message"></i>
                                      &nbsp;&nbsp;&nbsp;Send Message
                                </a>
                                {% elif request_already_sent %}
                                <button class="button has-icon is-bold">&#10003;&nbsp;&nbsp; Request Sent</button>

                                {% elif profile_user not in request.user.get_user_connected_users %}
                                <form method="POST" onsubmit="sendFriendRequest(event);$(this).next().show();$(this).hide();">
                                    {% csrf_token %}
                                    <input type="hidden" name="id" value="{{profile_user.id}}">
                                    <button type="submit" class="button has-icon is-bold menu-item" style="min-width: 130px;background: #5596e6;color: #fff;" data-content="education-content">
                                        <i class="mdi mdi-send"></i>
                                        &nbsp;&nbsp;&nbsp;Send Request
                                    </button>
                                </form>
                                <button style="display: none;" class="button has-icon is-bold">&#10003;&nbsp;&nbsp; Request Sent</button>

                                {% endif %}

                                {% if form.designation.value %}
                                <a class="button has-icon is-bold menu-item" style="min-width: 130px; margin-left: 20px;" data-content="education-content">
                                    <i class="mdi mdi-progress-check"></i>
                                      &nbsp;&nbsp;&nbsp;{{form.designation.value}}
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                </div>

                <div class="column">

                    <!-- About sections -->
                    <div class="profile-about side-menu">
                        <div class="left-menu">
                            <div class="left-menu-inner" style="overflow-x: auto; justify-content: flex-start;">
                                <div class="menu-item is-active" data-content="overview-content">
                                    <div class="menu-icon">
                                        <i class="mdi mdi-progress-check"></i>
                                        <span>Posts</span>
                                    </div>
                                </div>


                                <div class="menu-item" data-content="personal-content">
                                    <div class="menu-icon">
                                        <i class="mdi mdi-account-group"></i>
                                        <span>Friends</span>
                                    </div>
                                </div>

<!--                                <div class="menu-item" data-content="personal-content-list">-->
<!--                                    <div class="menu-icon">-->
<!--                                        <i class="mdi mdi-account-box-multiple"></i>-->
<!--                                        <span>Request Friends List</span>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                                <div class="menu-item" data-content="all-users">-->
<!--                                    <div class="menu-icon">-->
<!--                                        <i class="mdi mdi-account-group"></i>-->
<!--                                        <span>All users</span>-->
<!--                                    </div>-->
<!--                                </div>-->
                                <div class="menu-item" data-content="education-content">
                                    <div class="menu-icon">
                                        <i class="mdi mdi-school"></i>
                                        <span>Personal Info</span>
                                    </div>
                                </div>
                                {% if not user_friend %}
                                <div class="menu-item" data-content="job-content">
                                    <div class="menu-icon">
                                        <i class="mdi mdi-bookmark"></i>
                                        <span>Bookmark</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="right-content">
                            {% include 'users/user_posts.html' %}
                            {% include 'users/user_friends.html' %}
                            {% include 'users/user_requested.html' %}
                            {% include 'users/all_users.html' %}
                            {% if not user_friend %}
                            {% include 'users/user_bookmarks.html' %}
                            {% endif %}
                            {% include 'users/user_personal_info.html' %}
                        </div>

                    </div>
                </div>
            </div>

        </div>

        <!-- Change cover image modal -->
        <!--html/partials/pages/profile/timeline/modals/change-cover-modal.html-->
        <div id="change-cover-modal" class="modal change-cover-modal is-medium has-light-bg">
            <div class="modal-background"></div>
            <div class="modal-content">

                <div class="card">
                    <div class="card-heading">
                        <h3>Update Cover</h3>
                        <!-- Close X button -->
                        <div class="close-wrap">
                            <span class="close-modal">
                                    <i data-feather="x"></i>
                                </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Placeholder -->
                        <div class="selection-placeholder">
                            <div class="columns">
                                <div class="column is-6">
                                    <!-- Selection box -->
                                    <div class="selection-box modal-trigger" data-modal="upload-crop-cover-modal">
                                        <div class="box-content">
                                            <img src="{% static 'social_assets/img/illustrations/profile/upload-cover.svg' %}" alt="">
                                            <div class="box-text">
                                                <span>Upload</span>
                                                <span>From your computer</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-6">
                                    <!-- Selection box -->
                                    <div class="selection-box modal-trigger" data-modal="user-photos-modal">
                                        <div class="box-content">
                                            <img src="{% static 'social_assets/img/illustrations/profile/change-cover.svg' %}" alt="">
                                            <div class="box-text">
                                                <span>Choose</span>
                                                <span>From your photos</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- Change profile pic modal -->
        <!--html/partials/pages/profile/timeline/modals/change-profile-pic-modal.html-->
        <div id="change-profile-pic-modal" class="modal change-profile-pic-modal is-medium has-light-bg">
            <div class="modal-background"></div>
            <div class="modal-content">

                <div class="card">
                    <div class="card-heading">
                        <h3>Update Profile Picture</h3>
                        <!-- Close X button -->
                        <div class="close-wrap">
                            <span class="close-modal">
                                    <i data-feather="x"></i>
                                </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Placeholder -->
                        <div class="selection-placeholder">
                            <div class="columns">
                                <div class="column is-12">
                                    <!-- Selection box -->
                                    <div class="selection-box modal-trigger" data-modal="upload-crop-profile-modal">
                                        <div class="box-content">
                                            <img src="{% static 'social_assets/img/illustrations/profile/change-profile.svg' %}" alt="">
                                            <div class="box-text">
                                                <span>Upload</span>
                                                <span>From your computer</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
<!--                                <div class="column is-6">-->
<!--                                    &lt;!&ndash; Selection box &ndash;&gt;-->
<!--                                    <div class="selection-box modal-trigger" data-modal="user-photos-modal">-->
<!--                                        <div class="box-content">-->
<!--                                            <img src="{% static 'social_assets/img/illustrations/profile/upload-profile.svg' %}" alt="">-->
<!--                                            <div class="box-text">-->
<!--                                                <span>Choose</span>-->
<!--                                                <span>From your photos</span>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

                </div>

            </div>
        </div>
        <!-- Profile picture crop modal -->
        <!--html/partials/pages/profile/timeline/modals/upload-crop-profile-modal.html-->
        <div id="upload-crop-profile-modal" class="modal upload-crop-profile-modal is-xsmall has-light-bg">
            <div class="modal-background"></div>
            <div class="modal-content">
                <form method="POST" action="{% url 'user:update-profile-image' request.user.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="card">
                        <div class="card-heading">
                            <h3>Upload Picture</h3>
                            <!-- Close X button -->
                            <div class="close-wrap">
                                <span class="close-modal">
                                        <i data-feather="x"></i>
                                    </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <label class="profile-uploader-box" for="upload-profile-picture">
                                    <img src="{% static 'social_assets/img/illustrations/profile/add-profile.svg' %}" id="update-preview-image" style="object-fit: cover; object-position: center; width: 100%; height: 100%;" alt="">
                                    <input type="file" name="profile_image" id="upload-profile-picture" accept="image/*">
                            </label>
                            <div class="d-block ml-auto mr-auto my-2">Click above to upload a profile picture.</div>

                            <!-- <div class="upload-demo-wrap is-hidden">
                                <div id="upload-profile">
                                </div>
                                <div class="upload-help">
                                    <a id="profile-upload-reset" class="profile-reset is-hidden">Reset Picture</a>
                                </div>
                            </div> -->
                        </div>
                        <div class="card-footer">
                            <button id="submit-profile-picture" class="button is-solid accent-button is-fullwidth raised">Use Picture</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>


<script>
    function like(id) {
        var csrfmiddlewaretoken = $("input[name='csrfmiddlewaretoken']").val();
        $.ajax({
            async: true,
            method: "POST",
            url: "{% url 'post:like' %}",
            data: {
                csrfmiddlewaretoken: csrfmiddlewaretoken,
                'id': id,
            },
            success: function (response) {
                $('.likes-display' + id).html(response['likes']);
            },
            error: function (response) {
                console.log(response);
            },
        });
    }

    // Shows image preview after uploading.
    let oldImage = null;
    previewEl = document.getElementById('update-preview-image');
    document.getElementById('upload-profile-picture').addEventListener('change', function(e){
        const file = e.target.files[0];
        if (oldImage !== null) {
            URL.revokeObjectURL(oldImage)
            previewEl.style.display = 'none';
        }
        if (file){
            oldImage = URL.createObjectURL(file)
            previewEl.src = oldImage;
            previewEl.style.display = 'inline-block';
        }
    });

    // Accept Friend DOM manipulate
    const receivedUsersWrapper = document.getElementById('received-users');
    const connectedUsersWrapper = document.getElementById('connected-users');

    function acceptFriendsSectionUpdate(e, element, user_id) {
        e.preventDefault()

        acceptFriendRequest(event, reload=false, alert=false)

        const placeholderEl = $('#page-placeholder');
        if (placeholderEl.length){
           $(placeholderEl).remove();
        }
        const acceptedUser = receivedUsersWrapper.querySelector(`#received_user_${user_id}`)
        // From #received_user_<id>
        const infoObj = {
            'id': acceptedUser.dataset.id,
            'username': acceptedUser.dataset.username,
            'full_name': acceptedUser.dataset.full_name,
            'profile_link': acceptedUser.dataset.profile_link,
            'profile_image_link': acceptedUser.dataset.profile_image_url,
            'pk': acceptedUser.dataset.pk,
        }
        addFriendToSection(infoObj);
        acceptedUser.remove();
    }

    function addFriendToSection(user) {
        let $templateConnectedUser = $('#template-connected-user').clone(true, true)
        // For already friends
        const dataItems = [
            'username',
            'full_name',
            'profile_link',
            'profile_image_link',
            'pk'
        ]
        for (const dataItem of dataItems){
            if (['username', 'full_name'].includes(dataItem))
                $templateConnectedUser.find(`[data-template-${dataItem}="true"]`).text(user[dataItem])
            else if (['profile_image_link'].includes(dataItem)){
                $templateConnectedUser.find(`[data-template-${dataItem}="true"]`).attr('src', user[dataItem])
                $templateConnectedUser.find(`[data-template-${dataItem}="true"]`).attr('data-demo-src', user[dataItem])
            }
            else if (['profile_link'].includes(dataItem))
                $templateConnectedUser.find(`[data-template-${dataItem}="true"]`).attr('href', user[dataItem])
            else if (['pk'].includes(dataItem))
                $templateConnectedUser.find(`[data-template-${dataItem}="true"]`).attr('value', user[dataItem])
        }
        $templateConnectedUser.removeAttr('id')
        $templateConnectedUser.css('display', 'block')
        $('#connected-users').append($templateConnectedUser)
    }
    function updateTotalFriendsCounter(val) {
        totalFriendsCounterEl = document.getElementById('total-friends-counter');
        if (totalFriendsCounterEl){
            friendsCount = parseInt(totalFriendsCounterEl.innerText) + val;
            totalFriendsCounterEl.innerText = friendsCount;
            if (friendsCount <= 0){
                totalFriendsCounterEl.innerText = 0;
                const placeholderEl = $('#page-placeholder');
                if (placeholderEl.length){
                    $(placeholderEl).show();
                } else {
                    const html = `
                        <div class="page-placeholder" id="page-placeholder">
                            <div class="placeholder-content">
                                <img class="light-image" src="{% static 'social_assets/img/illustrations/placeholders/2.svg' %}" alt="" />
                                <img class="dark-image" src="{% static 'social_assets/img/illustrations/placeholders/2-dark.svg' %}" alt="" />
                                <h3>You don't have any friends yet.</h3>
                            </div>
                        </div>
                    `
                    document.getElementById('connected-users').insertAdjacentHTML('beforeend', html);
                }
            }
        }
    }
</script>
{% endblock %}